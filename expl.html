<!DOCTYPE html>
<html>

<head>
	<title>Полная экспликация парка</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="js/leaflet.css" />

	 <link rel="stylesheet" type="text/css" href="DataTables/datatables.css"/>

	 <!--script type="text/javascript" src="js/jquery.js"></script-->
	 <script type="text/javascript" src="DataTables/datatables.js"></script>

	<style>
		table[role=expl] {
			/*border-collapse: collapse;	/* Убираем двойные линии между ячейками */
		}
		table.dataTable tbody th, table.dataTable tbody td {
    		padding: 2px 4px;
		}
		table.dataTable {
			border-collapse: collapse;
		}

		td[role=expl],
		th[role=expl] {
			border: 1px solid black;
			margin-left: auto; /* Параметры рамки */
		}
		th[role=expl] {
			background: #b0e0e6;
			border: 1px solid black;
		}
		div.objTable {
			margin-left: auto;
		    margin-right: auto;
			width: auto;
			border-collapse: collapse;
		}
		div.dataTables_scrollHeadInner{
			margin-left: auto;
		    margin-right: auto;
}
	</style>
	<script src="js/leaflet.js" type="text/javascript"></script>
	<script src="js/osmtogeojson.js" type="text/javascript"></script>
	<script src="js/leaflet-providers.js" type="text/javascript"></script>
	<script src="js/leaflet.textpath.js" type="text/javascript"></script>
	<script src="explication.js" type="text/javascript"></script>

</head>

<body>
	<p id="status">Экспликация составляется, ожидаемое время до 15 секунд</br></p>
	<h1 id="obj_title"></h1>
	<h2>Экспликации парковых объектов</h2>
	<p id="filter0" style="display : none">Граница датировок - не позднее <span id="filter"></span></p>
	<div id="map" style="height: 700px; width:98%"></div>
	<p></p>
	<h3>Маточные площадки</h3>
	<div class="objTable">
		<table class="dataTable" id="Маточные_площадки"></table>
	</div>
	<h3>Справочные объекты</h3>	
	<div class="objTable">
		<table class="dataTable" id="Справочные_объекты"></table>
	</div>
	<h3>Водотоки</h3>
	<div class="objTable">
		<table class="dataTable" id="Водотоки"></table>
	</div>
	<h3>Дорожки</h3>	
	<div class="objTable">
		<table class="dataTable" id="Дорожно_тропиночая_сеть"></table>
	</div>
	<h3>Обсадки</h3>	
	<div class="objTable">
		<table class="dataTable" id="Обсадки"></table>
	</div>
	<h3>Специализированне площадки</h3>
	<div class="objTable">
		<table class="dataTable" id="Площадки"></table>
	</div>
	<h3>Урны</h3>	
	<div class="objTable">
		<table class="dataTable" id="Урны"></table>
	</div>
	<h3>Скамейки</h3>	
	<div class="objTable">
		<table class="dataTable" id="Скамейки"></table>
	</div>
	<h3>Достопримечательности</h3>
	<div class="objTable">
		<table class="dataTable" id="Достопримечательности"></table>
	 </div>
	<h3>Малые формы</h3>
	<div class="objTable">
		<table class="dataTable" id="Малые_формы"></table>
	</div>
	<h3>Объекты культурного наследия</h3>
	<div class="objTable">
		<table class="dataTable" id="Объекты_культурного_наследия"></table>
	 </div>
	<h3>Объекты фотосайта</h3>
	<div class="objTable">
		<table class="dataTable" id="Ref_Sirius_msk"></table>
	 </div>
	<p id="No"></p>
	<p id="note"></p>
	<script language="javascript">
		log.t0 = null;
		function log(x, t0) {
			if (t0)
				this.t0 = t0;
			console.log(x);
			this.tn0 = this.tn
			this.tn = new Date().getTime();
			console.log((this.tn - this.t0) / 1000 + (this.tn0 ? ('  (' + ((this.tn - this.tn0) / 1000) + ')') : ''));
		}

		function start_expl_process (osm_relation_id) {
			var t0 = new Date().getTime();
			log('Данные по контуру Дендропарка запрошены ', t0);
			explication.get_data(osm_relation_id, subAreaFilter);
		}

		window.addEventListener('hashchange', function (event) {
			hashChange();
		});
		hashChange();

		var filter = null;
		// Срабатывает при изменении адреса
		function hashChange () {
		var p = getJsonFromUrl();
		if (p.osmrel)
			start_expl_process(p.osmrel);
		}

		function gLayer(l) {
			return L.tileLayer(
				'http://{s}.google.com/vt/lyrs=' + l + '&x={x}&y={y}&z={z}',
				{
					maxZoom: 20,
					subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
				}
			);
		}

		function subAreaFilter(xhr) {
			log('Внутренние данные получены ');
			var xml = xhr.responseXML;
			// Выделяем участки дендропарка
			var osm_id_участки = geoAlb_lib.getSubAreas(xml, xhr.osm_relation_id);
			var geoJsonGeneral = osmtogeojson(xml);
			var участки = [];
			for (var i in osm_id_участки) {
				var id = osm_id_участки[i];
				var n = geoAlb_lib.relationSelfPolygon(geoJsonGeneral, id);
				участки.push(geoJsonGeneral.features[n]);
			}
			log('Участки выделены ');
			geoJsonGeneral.osm_relation_id = xhr.osm_relation_id;

			var el = decodeURI(location.hash).replace('#', '').split(';');
			var filter = el[1] ? el[1] : null;

			document.getElementById('filter').innerText = filter;
			explication.osm.function_general(
				geoJsonGeneral,
				участки,
				[
					'Esri.WorldImagery',
					'OpenTopoMap',
					'OpenStreetMap.Mapnik',
					'OpenStreetMap.DE',
					'OpenStreetMap.France',
					gLayer('s'),
					L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
						{ maxZoom: 28, attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="http://mapbox.com">Mapbox</a>', id: 'mapbox.streets' }),
					L.tileLayer('https://17200.selcdn.ru/AerialWWII/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1942,&copy; <a href="http://warfly.ru/">вермахт</a>', id: 'WWII1942.aero' }),
				/*	L.tileLayer('http://www.retromap.ru/tiles/r/5/061942/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1942,&copy;<a href="http://retromap.ru/">вермахт</a>', id: 'Retromap1942.aero' }),
					L.tileLayer('http://www.retromap.ru/tiles/r/5/051952/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1952, &copy; </a>', id: '1952.geo' }),*/
					gLayer('p'),
					gLayer('y'),
					L.tileLayer('https://tiles.openaerialmap.org/5fac302c3729bf000552677e/0/5fac302c3729bf000552677f/{z}/{x}/{y}',
						{ maxZoom: 22, attribution: '&copy; Сергей Астахов, нормаль аэрортофото Павловского Парка', id: 'pavlovsc_2020_aero_norm' }),
					L.tileLayer('https://tiles.openaerialmap.org/5fac2fcd3729bf000552677c/0/5fac2fcd3729bf000552677d/{z}/{x}/{y}',
						{ maxZoom: 24, attribution: '&copy; Сергей Астахов, оригинал аэрортофото Павловского Парка', id: 'pavlovsc_2020_aero_or' })
				],
				[
					'Снимки от Esri',
					'Топографическая карта',
					'ОСМ/Мапник',
					'ОСМ/Немецкая карта',
					'ОСМ/Французская карта',
					'Спутник Google',
					'MapBox',
					'Аэрофото 1942 г.',
				/*	'Аэрофото 1942 г.',
					'Москва 1952 г.',*/
					'Карта google',
					'Гибрид google',
					'Нормализ. аэроротофото Павловского парка 2020 г.',
					'Оригинальное аэроротофото Павловского парка 2020 г.'
				],
				getJsonFromUrl(),
				dataOutput.explicationDataProcess
			);
		}

		dataOutput = {
			dataColumns : function (sample){
				 var ac = [];
				 for (var a in sample){
					 if (a.indexOf('_') == -1)
							ac.push({ data : a, title : a });
				 }
				 return ac;
			},
			exportJSON : function (exportObj, exportName){
				 var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
				 var specialNode = document.createElement('a');
				 specialNode.setAttribute("href",	  dataStr);
				 specialNode.setAttribute("download", exportName + ".json");
				 document.body.appendChild(specialNode); // required for firefox
				 specialNode.click();
				 specialNode.remove();
			},
			exportSQL : function (exportObj, tableName, exportName){
				 var SQL = "";
				 for (var i in exportObj){
					var ins = "INSERT INTO " + tableName + " ("
					for (var a in exportObj[i])
							ins += "\"" + a + "\", ";
					ins.slice(0, -2);
					ins += ") VALUES (";
					for (var a in exportObj[i]){
							var v = exportObj[i][a];
							if (v == null)
								 ins += "NULL, ";
							else
								 ins += "'" + v + "', ";
					}
					ins.slice(0, -2);
					ins += ");\n";
						SQL += ins;
				 }

				 var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(SQL);
				 var specialNode = document.createElement('a');
				 specialNode.setAttribute("href",	  dataStr);
				 specialNode.setAttribute("download", exportName + ".sql");
				 document.body.appendChild(specialNode); // required for firefox
				 specialNode.click();
				 specialNode.remove();
			},
			filterExportData: function(source){
				var res = [];
				for (var i in source){
					var ex_a = {};
					for (var j in source[i]){
						 if (j.indexOf('_') == -1)
							 ex_a[j] = source[i][j];
					}
					res.push(ex_a);
				}
				return res;
			},
			explicationDataProcess : function (expl_data){
				// Заполнение всех табоиц
				for (var oi in expl_data) {
					var data_obj = expl_data[oi].data;
					var nd = document.getElementById(oi);
						if (data_obj.length == 0){
							nd.parentNode.style.display = 'none';
						} else {
							dataOutput.tabulation(nd, data_obj, oi);
							console.log(oi);
							var t = $(nd).DataTable( {
	    						buttons: [
                                    'copy', 'excel', 'pdf',
                                    'selectAll',
                					'selectCells',
				                	'selectColumns',
                					'selectNone',
				                	'selectRows',
				                	'selected',
				                	'selectedSingle'
                                ],
                				"scrollX": true,
                				language: dataTablesRu,
				                "dom": '<"wrapper"flipt>',
								"pageLength": 15
				                }
                			);
                			new $.fn.dataTable.Buttons( t, {
                                buttons: [
                                            'copy', 'excel', 'pdf'
                                         ]
                                } );
						}
				 }/*
			var source = data['Маточные площадки'].data;
			var export_obj = dataOutput.filterExportData(source);
			dataOutput.exportSQL(export_obj, '"Маточные площадки"', 'Маточные площадки');
			$('table.dataTable').DataTable( {
				"scrollY": 300,
				"scrollX": true,
				//data: export_obj,
				//"columns": dataOutput.dataColumns(export_obj[0]),
				language: dataTablesRu,
				buttons: [
					'pdf',
					'selectAll',
					'selectCells',
					'selectColumns',
					'selectNone',
					'selectRows',
					'selected',
					'selectedSingle'
				],
				"dom": '<"wrapper"flipt>'
				}
			);*/
			},
			// Формирование экспликационной таблицы по массиву
			tabulation : function (tbl, table_obj, title) {
				tbl.setAttribute('role', 'expl');
				var thh = document.createElement('thead');
				var tr = document.createElement('tr');
				tr.setAttribute('role', 'expl');
				for (var j in table_obj[0]) {
					if (j.indexOf('_') == 0)
						continue;
					var th = document.createElement('th');
					th.setAttribute('role', 'expl');
					th.innerHTML = j.replace('_', ' ');
					tr.appendChild(th);
				}
				thh.appendChild(tr);
				tbl.appendChild(thh);

				var tbd = document.createElement('tbody');
				for (var i_ in table_obj) {
					var tobji = table_obj[i_];
					var tr = document.createElement('tr');
					tr.setAttribute('role', 'expl');
					for (var j in tobji) {
						if (j.indexOf('_') == 0)
							continue;
						var td = document.createElement('td');
						td.setAttribute('role', 'expl');
						td.innerHTML = tobji[j];
						tr.appendChild(td);
					}
				tbd.appendChild(tr);
				}
				tbl.appendChild(tbd);
			}
		};

		function getJsonFromUrl(url) {
			if(!url)
				url = location.href;
			var q = url.indexOf("?");
			var h = url.indexOf("#");
			if(h==-1 && q==-1)
				return {};
			if(h==-1)
				h = url.length;
			if (q==-1)
				var query = url.substring(h+1, url.length);
			else
				var query = url.substring(q+1, url.length);
			var result = {};
			query.split("&").forEach(function(part) {
	 				if(!part)
					return;
	 				part = part.split("+").join(" "); // replace every + with space, regexp-free version
	 				var eq = part.indexOf("=");
	 				var key = eq>-1 ? part.substr(0,eq) : part;
		 			var val = eq>-1 ? decodeURIComponent(part.substr(eq+1)) : "";
	 				var from = key.indexOf("[");
	 				if(from==-1)
					result[decodeURIComponent(key)] = val;
		 			else {
							var to = key.indexOf("]",from);
					var index = decodeURIComponent(key.substring(from+1,to));
					key = decodeURIComponent(key.substring(0,from));
					if(!result[key])
						result[key] = [];
					if(!index)
						result[key].push(val);
					else
						result[key][index] = val;
					}
				});
			return result;
		}
		var dataTablesRu = {
			"decimal":		  ",",
			"emptyTable":	  "Таблица пуста",
			"info":			  "Показано от _START_ до _END_ из _TOTAL_ записей",
			"infoEmpty":		"Показано от 0 до 0 из 0 записей",
			"infoFiltered":	"(отобрано из _MAX_ записей)",
			"infoPostFix":	 "",
			"thousands":		"'",
			"lengthMenu":	  "Показано _MENU_ записей",
			"loadingRecords": "Загружается...",
			"processing":	  "Обрабатывается...",
			"search":			"Найти:",
			"zeroRecords":	 "Подходящих записей нет",
			"paginate": {
			  "first":		"Первая",
			  "last":		 "Последняя",
			  "next":		 "Следующая",
			  "previous":	"Переыдущая"
			},
			"aria": {
			  "sortAscending":  ": вызывает сортировку по возрастанию",
			  "sortDescending": ": вызывает сортировку по убыванию"
			}
		};
	</script>
</body>
</html>
