<!DOCTYPE html>
<html>

<head>
	<title>Полная экспликация парка</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<link rel="stylesheet" href="js/leaflet.css" />
	<style>
		table[role=expl] {
			border-collapse: collapse;
			/* Убираем двойные линии между ячейками */
		}

		td[role=expl],
		th[role=expl] {
			padding: 3px;
			/* Поля вокруг содержимого таблицы */
			border: 1px solid black;
			/* Параметры рамки */
		}

		th[role=expl] {
			background: #b0e0e6;
			/* Цвет фона */
		}

		th[role=expl] {
			position: sticky;
			top: 0;
		}

		table {
			border-collapse: collapse;
			/* Убираем двойные линии между ячейками */
		}

		td,
		th {
			padding: 3px;
			/* Поля вокруг содержимого таблицы */
			border: 1px solid black;
			/* Параметры рамки */
		}

		th {
			background: #b0e6b0;
			/* Цвет фона */
		}
	</style>
	<script src="js/leaflet.js" type="text/javascript"></script>
	<script src="js/osmtogeojson.js" type="text/javascript"></script>
	<script src="js/leaflet-providers.js" type="text/javascript"></script>
	<script src="js/leaflet.textpath.js" type="text/javascript"></script>
	<script src="explication.js" type="text/javascript"></script>
</head>

<body>
	<p id="status">Экспликация составляется, ожидаемое время до 15 секунд</p>
	<p></p>
	<h3 id="obj_title"></h3>
	<h3>Экспликации парковых объектов</h3>
	<p id="filter0">Граница датировок - не позднее <span id="filter"></span></p>
	<!--p>На карте обозначены</br>Цветом линии тип листвы</br>Заливкой сезонность</br>Толщиной контура - древесная или
		кустарниковая растительность</p -->
	<div id="map" style="height: 700px; width:98%"></div>
	<p></p>
	<p>Экспликация маточных площадок</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="МаточнаяПлощадка"></div>
	</div>
	<p>Экспликация справочных объектов</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Справочные_объекты"></div>
	</div>
	<p>Экспликация водотоков</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Водоток"></div>
	</div>
	<p>Экспликация дорожек</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Дорожка"></div>
	</div>
	<p>Экспликация обсадок</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Обсадка"></div>
	</div>	
	<p>Экспликация специальных площадок</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Площадки"></div>
	</div>
	<p>Экспликация урн</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Урны"></div>
	</div>
	<p>Экспликация скамеек</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Скамейки"></div>
	</div>
	<p>Экспликация достопримечательностей</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Достопримечательности"></div>
	</div>
	<p>Экспликация малых форм</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Малые_формы"></div>
	</div>
	<p>Экспликация объектов культурного наследия</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Объекты_культурного_наследия"></div>
	</div>
	<p>Экспликация объектов с кодом фотосайта-путеводителя Московские Парки</p>
	<div style="margin: auto; overflow: auto; height: 450px">
		<div id="Ref_Sirius_msk"></div>
	</div>
	<p id="No"></p>
	<p id="note"></p>
	<script language="javascript">
		log.t0 = null;
		function log(x, t0) {
			if (t0)
				this.t0 = t0;
			console.log(x);
			this.tn0 = this.tn
			this.tn = new Date().getTime();
			console.log((this.tn - this.t0) / 1000 + (this.tn0 ? ('  (' + ((this.tn - this.tn0) / 1000) + ')') : ''));
		}

		function start_expl_process (osm_relation_id) {		
			var t0 = new Date().getTime();
			log('Данные по контуру Дендропарка запрошены ', t0);
			explication.get_data(osm_relation_id, subAreaFilter);
		}

		window.addEventListener('hashchange', function (event) {
			hashChange();
		});
		hashChange();
		
		var filter = null;
		// Срабатывает при изменении адреса
		function hashChange () {
		var p = getJsonFromUrl(window.location.hash);		
		if (p.osmrel)
			start_expl_process(p.osmrel);
		}

		function gLayer(l) {	
			return L.tileLayer(
				'http://{s}.google.com/vt/lyrs=' + l + '&x={x}&y={y}&z={z}',
				{
					maxZoom: 20,
					subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
				}
			);
		}

		function subAreaFilter(xhr) {
			log('Внутренние данные получены ');
			var xml = xhr.responseXML;
			// Выделяем участки дендропарка
			var osm_id_участки = geoAlb_lib.getSubAreas(xml, xhr.osm_relation_id);
			var geoJsonGeneral = osmtogeojson(xml);
			var участки = [];
			for (var i in osm_id_участки) {
				var id = osm_id_участки[i];
				var n = geoAlb_lib.relationSelfPolygon(geoJsonGeneral, id);
				участки.push(geoJsonGeneral.features[n]);
			}
			log('Участки выделены ');
			geoJsonGeneral.osm_relation_id = xhr.osm_relation_id;

			var el = decodeURI(location.hash).replace('#', '').split(';');
			var filter = el[1] ? el[1] : null;

			document.getElementById('filter').innerText = filter;
			explication.osm.function_general(
				geoJsonGeneral,
				участки,
				[
					'Esri.WorldImagery',
					'OpenTopoMap',
					'OpenStreetMap.Mapnik',
					'OpenStreetMap.DE',
					'OpenStreetMap.France',
					gLayer('s'),
					L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
						{ maxZoom: 28, attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="http://mapbox.com">Mapbox</a>', id: 'mapbox.streets' }),
					L.tileLayer('https://17200.selcdn.ru/AerialWWII/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1942,&copy; <a href="http://warfly.ru/">вермахт</a>', id: 'WWII1942.aero' }),
				/*	L.tileLayer('http://www.retromap.ru/tiles/r/5/061942/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1942,&copy;<a href="http://retromap.ru/">вермахт</a>', id: 'Retromap1942.aero' }),
					L.tileLayer('http://www.retromap.ru/tiles/r/5/051952/Z{z}/{y}/{x}.jpg',
						{ maxZoom: 18, attribution: '1952, &copy; </a>', id: '1952.geo' }),*/
					gLayer('y'),
					gLayer('p')
				],
				[						 
					'Снимки от Esri', 
					'Топографическая карта', 
					'ОСМ/Мапник',
					'ОСМ/Немецкая карта',
					'ОСМ/Французская карта',
					'Спутник Google',  
					'MapBox',
					'Аэрофото 1942 г.', 
				/*	'Аэрофото 1942 г.', 
					'Москва 1952 г.',*/
					'Карта google', 
					'Гибрид google',
				],
				filter
			);
		}
		
		function getJsonFromUrl(url) {
  			if(!url) url = location.href;
  			var question = url.indexOf("?");
  			var hash = url.indexOf("#");
  			if(hash==-1 && question==-1) return {};
  			if(hash==-1) hash = url.length;
  			var query = question==-1 || hash==question+1 ? url.substring(hash) : 
  			url.substring(question+1,hash);
  			var result = {};
  			query.split("&").forEach(function(part) {
    				if(!part)
					return;
    				part = part.split("+").join(" "); // replace every + with space, regexp-free version
    				var eq = part.indexOf("=");
    				var key = eq>-1 ? part.substr(0,eq) : part;
	    			var val = eq>-1 ? decodeURIComponent(part.substr(eq+1)) : "";
    				var from = key.indexOf("[");
    				if(from==-1)
					result[decodeURIComponent(key)] = val;
	    			else {
      					var to = key.indexOf("]",from);				
					var index = decodeURIComponent(key.substring(from+1,to));
					key = decodeURIComponent(key.substring(0,from));
					if(!result[key])
						result[key] = [];
					if(!index)
						result[key].push(val);
					else 
						result[key][index] = val;
					}
				});
			return result;
		}
	</script>
</body>
</html>
